<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²¡å±±å››æ—¥è¼•æ—…</title>
    <!-- PWA / iOS å…¨è¢å¹• (å»é™¤ç¶²å€åˆ—) Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5A7F7A">
    <!-- Apple Touch Icon (iOS åŠ å…¥ä¸»ç•«é¢åœ–ç¤º) -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/5A7F7A/FFFFFF?text=JP">
    <!-- PWA Manifest Link (å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ) -->
    <link rel="manifest" id="manifest-link" href=""> 
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts for Japanese/Taiwanese Aesthetic (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* æ—¥ç³»ç°¡ç´„é¢¨æ ¼è¨­å®š */
        :root {
            --color-primary: #5A7F7A; /* æŸ”å’Œç¶  */
            --color-secondary: #F0EDE5; /* æ·ºç±³ç™½ */
            --color-accent: #E57373; /* æŸ”å’Œç´… (ç”¨æ–¼å¼·èª¿æ™‚é–“) */
            --color-text: #2D3748; /* æ·±ç° */
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-secondary);
            color: var(--color-text);
            padding-bottom: 72px; /* ç•™çµ¦åº•éƒ¨å°èˆªåˆ—çš„ç©ºé–“ */
        }
        .card {
            background-color: white;
            border-radius: 1rem; /* åœ“è§’ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* æŸ”å’Œé™°å½± */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .nav-active {
            color: var(--color-primary);
            font-weight: 500;
        }
        .tab-content {
            display: none;
            padding: 1rem;
        }
        .highlight-time {
            color: var(--color-accent);
            font-weight: 700;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4A6E69;
        }
        .timeline-item {
            border-left: 2px solid var(--color-primary);
            padding-left: 1.5rem;
            margin-left: 0.5rem;
            position: relative;
        }
        .timeline-dot {
            position: absolute;
            left: -8px;
            top: 0.25rem;
            width: 14px;
            height: 14px;
            background-color: white;
            border: 2px solid var(--color-primary);
            border-radius: 9999px;
        }
        .weather-banner {
            background-image: linear-gradient(to right, #B2EBF2, #E0F7FA);
            color: #00838F;
        }
        .map-icon {
            color: var(--color-primary);
        }
        /* Custom styles for the calculator */
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        .calculator-btn {
            background-color: #F8F8F8;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--color-text);
            transition: background-color 0.1s;
        }
        .calculator-btn:active {
            background-color: #E0E0E0;
        }
        .calculator-op {
            background-color: #E0F7FA;
            color: #00838F;
        }
        .calculator-eq {
            background-color: var(--color-primary);
            color: white;
            grid-column: span 2;
        }
        /* Style for the embedded map iframe */
        #guide-map {
            border-radius: 1rem;
            width: 100%;
            height: 300px;
        }

        /* --- PWA/Splash Screen Styles --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-secondary); /* æ·ºç±³ç™½èƒŒæ™¯ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .app-logo {
            font-size: 4rem;
            color: var(--color-primary);
            animation: bounce-in 1s ease-out forwards;
        }
        .app-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text);
            margin-top: 1rem;
            opacity: 0;
            animation: fade-in 1s ease-out 0.5s forwards;
        }
        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .hidden-splash {
            pointer-events: none;
            opacity: 0 !important;
        }
        
        /* A2HS æç¤ºæ¬„ */
        #a2hs-prompt {
            position: sticky;
            top: 0;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 10px;
            z-index: 99; /* é«˜æ–¼ Header */
            display: none; /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 1. Splash Screen (App å•Ÿå‹•ç•«é¢) -->
    <div id="splash-screen">
        <div class="app-logo">
            <i class="fas fa-route"></i>
        </div>
        <div class="app-title">å²¡å±±è¼•æ—…å•Ÿå‹•ä¸­...</div>
    </div>
    
    <!-- 2. A2HS Prompt (é App æ¨¡å¼ä¸‹é¡¯ç¤ºçš„åŠ å…¥ä¸»ç•«é¢æç¤º) -->
    <div id="a2hs-prompt" class="flex justify-between items-center text-sm">
        <p class="flex-grow text-center"><i class="fab fa-apple mr-2"></i> é»æ“Šã€Œåˆ†äº«ã€å¾Œé¸ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ï¼Œç²å¾—å®Œæ•´ App é«”é©—ï¼</p>
        <button onclick="document.getElementById('a2hs-prompt').style.display='none';" class="text-gray-400 hover:text-white ml-3">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Header & Title -->
    <header class="p-4 bg-white shadow-sm sticky top-0 z-10">
        <h1 class="text-xl font-bold text-center text-gray-800">å²¡å±±å››æ—¥è¼•æ—…è¡Œ</h1>
        <p class="text-sm text-center text-gray-500 mt-1">Single File æ—…éŠå°å¹«æ‰‹</p>
    </header>

    <!-- Main Content Area -->
    <main id="app-content">

        <!-- 1. PLAN (è¡Œç¨‹è¡¨) Tab Content -->
        <div id="tab-plan" class="tab-content block">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">âœˆï¸ è¡Œç¨‹ç¸½è¦½ (PLAN)</h2>
            
            <!-- Day Navigation ç§»è‡³ä¸Šæ–¹ -->
            <div class="flex justify-center mb-4 space-x-2">
                <button onclick="changeDay(1)" class="day-btn btn-primary bg-opacity-80">Day 1</button>
                <button onclick="changeDay(2)" class="day-btn btn-primary bg-opacity-50">Day 2</button>
                <button onclick="changeDay(3)" class="day-btn btn-primary bg-opacity-50">Day 3</button>
                <button onclick="changeDay(4)" class="day-btn btn-primary bg-opacity-50">Day 4</button>
            </div>
            
            <div id="plan-itinerary">
                <!-- Daily Content will be generated here by JS -->
            </div>
        </div>

        <!-- 2. GUIDE (æ·±åº¦å°è¦½) Tab Content -->
        <div id="tab-guide" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">â›©ï¸ æ·±åº¦å°è¦½ (GUIDE)</h2>

            <!-- åœ°åœ–å€å¡Š -->
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3">ğŸ“ æ—…ç¨‹åœ°åœ–æ¦‚è¦½</h3>
                <!-- Google Maps Embed for Okayama/Kagawa area -->
                <iframe id="guide-map"
                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d198884.2346740683!2d133.6841267425121!3d34.46824490704043!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x35511af41b802677%3A0x3500d4d7a72d326!2z5b6D5b6e5bmV55yM5b6D5b6e6aeF!5e0!3m2!1szh-TW!2stw!4v1701723652870!5m2!1szh-TW!2stw"
                    allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>

            <!-- æ·±åº¦å°è¦½å…§å®¹å€å¡Š (å‹•æ…‹ç”Ÿæˆæ‰€æœ‰æ™¯é»/é¤å»³/äº¤é€š) -->
            <div id="guide-content" class="space-y-4">
                <!-- Guide content will be dynamically generated by JS -->
            </div>
        </div>

        <!-- 3. WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) Tab Content -->
        <div id="tab-wallet" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ (WALLET)</h2>

            <!-- åŒ¯ç‡æ›ç®—å™¨ (é»æ“Šé–‹å•Ÿ/æ”¶åˆ) -->
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleCalculator()">
                    <h3 class="text-xl font-medium">åŒ¯ç‡æ›ç®—å™¨</h3>
                    <i id="calculator-toggle-icon" class="fas fa-chevron-up text-lg text-gray-500"></i>
                </div>
                
                <!-- Collapsible Calculator Body -->
                <div id="calculator-body" class="mt-4">
                    <div class="flex items-center justify-between mb-3">
                        <label for="exchange-rate" class="text-sm font-medium">åŒ¯ç‡ (JPY 1 = TWD)</label>
                        <input type="number" id="exchange-rate" value="0.22" step="0.001" class="w-24 p-2 border rounded-lg text-right focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                    </div>

                    <div class="bg-gray-100 p-3 rounded-xl mb-4">
                        <div id="calculator-display" class="text-right text-3xl font-bold mb-2 h-10 overflow-hidden">0</div>
                        <div id="calculator-twd-result" class="text-right text-base text-gray-600">ç´„ NT$ 0.00</div>
                    </div>
                    
                    <div class="calculator-grid">
                        <button class="calculator-btn" onclick="appendToExpression('1')">1</button>
                        <button class="calculator-btn" onclick="appendToExpression('2')">2</button>
                        <button class="calculator-btn" onclick="appendToExpression('3')">3</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('+')"><i class="fas fa-plus"></i></button>
                        
                        <button class="calculator-btn" onclick="appendToExpression('4')">4</button>
                        <button class="calculator-btn" onclick="appendToExpression('5')">5</button>
                        <button class="calculator-btn" onclick="appendToExpression('6')">6</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('-')"><i class="fas fa-minus"></i></button>

                        <button class="calculator-btn" onclick="appendToExpression('7')">7</button>
                        <button class="calculator-btn" onclick="appendToExpression('8')">8</button>
                        <button class="calculator-btn" onclick="appendToExpression('9')">9</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('*')"><i class="fas fa-times"></i></button>

                        <button class="calculator-btn" onclick="appendToExpression('C')">C</button>
                        <button class="calculator-btn" onclick="appendToExpression('0')">0</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('.')">.</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('/')"><i class="fas fa-divide"></i></button>
                        
                        <button class="calculator-btn calculator-eq" onclick="calculateResult()">=</button>
                        <button class="calculator-btn calculator-eq" onclick="appendToExpression('(')">(</button>
                        <button class="calculator-btn calculator-eq" onclick="appendToExpression(')')">)</button>
                    </div>
                </div>
            </div>

            <!-- è¨˜å¸³æ–°å¢å€ -->
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">æ–°å¢æ¶ˆè²»ç´€éŒ„</h3>
                <form id="expense-form" class="space-y-3">
                    <div>
                        <label for="item-name" class="text-sm font-medium">å“é …</label>
                        <input type="text" id="item-name" required class="w-full p-2 border rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                    </div>
                    <div>
                        <label for="item-jpy" class="text-sm font-medium">æ—¥å¹£é‡‘é¡ (Â¥)</label>
                        <input type="number" id="item-jpy" required min="1" class="w-full p-2 border rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)">
                    </div>
                    <div>
                        <label class="text-sm font-medium">æ”¯ä»˜æ–¹å¼</label>
                        <div class="flex space-x-4 mt-1">
                            <label class="inline-flex items-center">
                                <input type="radio" name="payment-type" value="Cash" checked class="form-radio text-var(--color-primary)">
                                <span class="ml-2">ç¾é‡‘</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="payment-type" value="Credit" class="form-radio text-var(--color-primary)">
                                <span class="ml-2">ä¿¡ç”¨å¡</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium">æ”¶æ“šç…§ç‰‡ (é¸å¡«)</label>
                        <input type="file" id="item-photo" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-var(--color-primary) file:text-white hover:file:bg-var(--color-primary)">
                        <input type="hidden" id="photo-base64">
                    </div>
                    <button type="submit" class="btn-primary w-full mt-4"><i class="fas fa-plus mr-2"></i> æ–°å¢ç´€éŒ„</button>
                </form>
            </div>

            <!-- è¨˜å¸³åˆ—è¡¨ -->
            <h3 class="text-xl font-medium mb-3 border-b pb-2">æ­·å²ç´€éŒ„</h3>
            <div id="expense-list" class="space-y-3">
                <!-- Records will be displayed here -->
            </div>
        </div>

        <!-- 4. LISTS (æ¸…å–®) Tab Content -->
        <div id="tab-lists" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">ğŸ“ æ¸…å–®èˆ‡å‚™å¿˜ (LISTS)</h2>

            <!-- è¡Œå‰æº–å‚™ Checklist -->
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2 text-green-700"><i class="fas fa-clipboard-check mr-2"></i> è¡Œå‰æº–å‚™ Checklist</h3>
                
                <!-- æ–°å¢é …ç›®åŠŸèƒ½ -->
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-checklist-item" placeholder="æ–°å¢è‡ªè¨‚æ¸…å–®é …ç›®..." 
                        class="flex-grow p-2 border rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary)"
                        onkeydown="if(event.key === 'Enter') { event.preventDefault(); addChecklistItem(); }">
                    <button onclick="addChecklistItem()" class="btn-primary flex-shrink-0">
                        <i class="fas fa-plus"></i> æ–°å¢
                    </button>
                </div>

                <div id="checklist-items" class="space-y-3">
                    <!-- Checklist items here -->
                </div>
            </div>

            <!-- å€‹äººå‚™å¿˜éŒ„ -->
            <div class="card p-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2 text-indigo-700"><i class="fas fa-lightbulb mr-2"></i> å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-text" rows="6" class="w-full p-3 border rounded-lg focus:ring-var(--color-primary) focus:border-var(--color-primary) resize-none" placeholder="è¼¸å…¥æ‚¨çš„å‚™å¿˜éŒ„æˆ–ç¶²å€..."></textarea>
                <div id="memo-output" class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-500 mb-2">é€£çµé è¦½ (ç¶²å€å°‡è‡ªå‹•è½‰æ›ç‚ºæŒ‰éˆ•)</p>
                    <div id="memo-links" class="space-y-2">
                        <!-- Converted links here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. INFO (è³‡è¨Š) Tab Content -->
        <div id="tab-info" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">â„¹ï¸ æ—…éŠè³‡è¨Š (INFO)</h2>

            <!-- èˆªç­èˆ‡ä½å®¿ -->
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">èˆªç­èˆ‡ä½å®¿è³‡è¨Š</h3>
                <p class="text-sm mb-2"><i class="fas fa-plane mr-2 text-blue-500"></i> **å»ç¨‹**: è™èˆª IT214 | 11:10 å°åŒ— â†’ 14:35 å²¡å±±</p>
                <p class="text-sm mb-4"><i class="fas fa-plane-arrival mr-2 text-blue-500"></i> **å›ç¨‹**: è™èˆª IT215 | 15:25 å²¡å±± â†’ 17:30 å°åŒ—</p>
                
                <p class="text-sm font-medium text-gray-700 mb-1">ğŸ  ä½å®¿åœ°é»</p>
                <p class="text-sm mb-2 break-words">æ—¥æœ¬ã€’700-0026 Okayama, Kita Ward, Hokancho, 1 Chomeâˆ’2âˆ’3 ã›ã‹ã‚“ã©ã‚†ãƒ¼ã™è¥¿å£ 505å·å®¤</p>
                <a href="https://maps.app.goo.gl/3QW7v5c3X2yFwA648" target="_blank" class="text-xs text-blue-500 underline"><i class="fas fa-map-marker-alt mr-1"></i> é–‹å•Ÿ Google Maps</a>
            </div>

            <!-- ç§Ÿè»Šè³‡è¨Š -->
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">ç§Ÿè»Šè³‡è¨Š</h3>
                <p class="text-sm mb-1"><i class="fas fa-car mr-2 text-yellow-600"></i> **ç§Ÿè»Šå…¬å¸**: Budget Car Rental ãƒã‚¸ã‚§ãƒƒãƒˆ ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ å²¡å±±é§…å‰è¥¿å£åº—</p>
                <p class="text-sm mb-1">**å–è»Š**: 01/18ï¼ˆå…­ï¼‰09:00</p>
                <p class="text-sm mb-1">**é‚„è»Š**: 01/19ï¼ˆæ—¥ï¼‰08:30</p>
                <a href="https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA" target="_blank" class="text-xs text-blue-500 underline"><i class="fas fa-map-marker-alt mr-1"></i> å–/é‚„è»Šåœ°é»åœ°åœ–</a>
            </div>

            <!-- å¤©æ°£èˆ‡ç·Šæ€¥é€£çµ¡ -->
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">ç•¶åœ°è³‡è¨Šèˆ‡ç·Šæ€¥é€£çµ¡</h3>
                
                <p class="text-sm font-medium text-gray-700 mb-1">â˜€ï¸ ç•¶åœ°å¤©æ°£</p>
                <a href="https://www.jma.go.jp/jma/index.html" target="_blank" class="text-sm text-blue-500 underline mb-3 block"><i class="fas fa-cloud-sun mr-1"></i> æ—¥æœ¬æ°£è±¡å»³ï¼ˆJMAï¼‰å®˜æ–¹é€£çµ</a>

                <p class="text-sm font-medium text-gray-700 mb-1 mt-3">ğŸš¨ ç·Šæ€¥é€£çµ¡é›»è©±</p>
                <p class="text-sm">**è­¦å¯Ÿ**: 110 (æ’¥æ‰“)</p>
                <p class="text-sm">**æ•‘è­·è»Š/æ¶ˆé˜²**: 119 (æ’¥æ‰“)</p>
                <p class="text-sm text-red-600">**é§æ—¥è¾¦äº‹è™•**: (+81) 3-3280-7811 (æ±äº¬) æˆ– (+81) 86-224-5477 (å¤§é˜ªåˆ†æ”¯ - åƒ…ä¾›åƒè€ƒ)</p>
            </div>

            <!-- æ—…éŠç¦å¿Œèˆ‡è¦ç¯„ -->
            <div class="card p-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">âš ï¸ æ—…éŠæ³¨æ„äº‹é …</h3>
                <ul class="list-disc pl-5 text-sm space-y-1">
                    <li>**éš¨èº«æ¶²é«”**ï¼šå–®ä¸€å®¹å™¨ä¸å¾—è¶…é 100mlï¼Œæ‰€æœ‰å®¹å™¨éœ€è£å…¥ 1 å…¬å‡çš„é€æ˜å¤¾éˆè¢‹å…§ã€‚</li>
                    <li>**è™èˆªæ‰‹æè¡Œæ**ï¼šæ¯äººé™ 2 ä»¶ï¼Œç¸½é‡ä¸å¾—è¶…é 10 å…¬æ–¤ã€‚</li>
                    <li>**æµ·é—œé•ç¦å“**ï¼šåš´ç¦æ”œå¸¶è‚‰é¡è£½å“ã€æœªç¶“æª¢ç–«çš„æ°´æœã€é«˜åŠ‘é‡é›»å­è¸æ²¹ç­‰å…¥å¢ƒã€‚</li>
                    <li>**ç¦®å„€**ï¼šåœ¨æ—¥æœ¬æ­ä¹˜å¤§çœ¾é‹è¼¸è«‹å‹¿å¤§è²è¬›é›»è©±ã€‚</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Fixed Bottom Navigation Bar (åº•éƒ¨å°èˆªåˆ—) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-20">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <button id="nav-plan" class="nav-btn flex flex-col items-center justify-center p-2 nav-active" onclick="showTab('plan')">
                <i class="fas fa-calendar-alt text-lg"></i>
                <span class="text-xs mt-1">è¡Œç¨‹è¡¨</span>
            </button>
            <button id="nav-guide" class="nav-btn flex flex-col items-center justify-center p-2" onclick="showTab('guide')">
                <i class="fas fa-compass text-lg"></i>
                <span class="text-xs mt-1">å°è¦½</span>
            </button>
            <button id="nav-wallet" class="nav-btn flex flex-col items-center justify-center p-2" onclick="showTab('wallet')">
                <i class="fas fa-wallet text-lg"></i>
                <span class="text-xs mt-1">è¨˜å¸³</span>
            </button>
            <button id="nav-lists" class="nav-btn flex flex-col items-center justify-center p-2" onclick="showTab('lists')">
                <i class="fas fa-list-ul text-lg"></i>
                <span class="text-xs mt-1">æ¸…å–®</span>
            </button>
            <button id="nav-info" class="nav-btn flex flex-col items-center justify-center p-2" onclick="showTab('info')">
                <i class="fas fa-info-circle text-lg"></i>
                <span class="text-xs mt-1">è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <!-- JavaScript Logic -->
    <script>
        // ====================================================================
        // GLOBAL DATA & INITIALIZATION
        // ====================================================================

        const STORAGE_KEY_EXPENSES = 'okayamaTripExpenses';
        const STORAGE_KEY_CHECKLIST = 'okayamaTripChecklist'; // å­˜å„² checklistItems
        const STORAGE_KEY_MEMO = 'okayamaTripMemo';
        const STORAGE_KEY_RATE = 'okayamaTripExchangeRate';
        
        let expenses = [];
        let checklistItems = []; // æ–°å¢ï¼šç”¨æ–¼å„²å­˜æ‰€æœ‰æ¸…å–®é …ç›®çš„é™£åˆ—
        let currentDay = 1;
        let exchangeRate = parseFloat(localStorage.getItem(STORAGE_KEY_RATE)) || 0.22;
        let isCalculatorOpen = true; // åˆå§‹ç‹€æ…‹ç‚ºå±•é–‹
        
        // å›ºå®šçš„åˆå§‹æ¸…å–®é …ç›® (ç”¨æ–¼ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚å»ºç«‹è³‡æ–™çµæ§‹)
        const INITIAL_CHECKLIST_STRINGS = [
            'è­·ç…§', 'ç¶²å¡', 'å……é›»ç·š', 'éŒ¢åŒ…', 'è¡Œå‹•é›»æº'
        ];

        // æ·±åº¦å°è¦½çš„è³‡æ–™é›†åˆ
        const COMPREHENSIVE_GUIDE = [
            {
                title: 'âœˆï¸ å²¡å±±æ©Ÿå ´ (OKJ)',
                category: 'äº¤é€š',
                mapLink: 'https://maps.app.goo.gl/YfL4E5bQ9d2L6JqG9',
                icon: 'fas fa-plane-departure',
                description: 'å²¡å±±ç¸£çš„ä¸»è¦åœ‹éš›é–€æˆ¶ï¼Œä½æ–¼å²¡å±±å¸‚å€åŒ—å´ï¼Œä¸»è¦æœå‹™åœ‹å…§ç·šèˆ‡éƒ¨åˆ†åœ‹éš›èˆªç·šï¼ˆå¦‚å°åŒ—è™èˆªï¼‰ã€‚æ©Ÿå ´æœ‰å·´å£«ç›´é”å²¡å±±è»Šç«™ï¼Œäº¤é€šä¾¿åˆ©ã€‚',
                tips: 'æ©Ÿå ´å·´å£«è»Šç¨‹ç´„ 30-40 åˆ†é˜ï¼Œè«‹æº–å‚™å¥½é›¶éŒ¢æˆ–ä½¿ç”¨äº¤é€šå¡ã€‚'
            },
            {
                title: 'ğŸ  ã›ã‹ã‚“ã©ã‚†ãƒ¼ã™è¥¿å£ 505è™Ÿå®¤ (ä½å®¿)',
                category: 'ä½å®¿',
                mapLink: 'https://maps.app.goo.gl/3QW7v5c3X2yFwA648',
                icon: 'fas fa-home',
                description: 'é è¿‘å²¡å±±è»Šç«™è¥¿å£é™„è¿‘çš„èˆ’é©ä½å®¿å…¬å¯“ã€‚åœ°é»æ–¹ä¾¿ï¼Œé©åˆè¼•æ—…è¡Œè€…ä½œç‚ºå››æ—¥éŠçš„åŸºåœ°ã€‚',
                tips: 'è·é›¢è¥¿å£å¾ˆè¿‘ï¼Œæ­¥è¡Œå³å¯åˆ°é”è»Šç«™ï¼Œä¾¿æ–¼æ­ä¹˜æ–°å¹¹ç·šæˆ–åœ°æ–¹åˆ—è»Šã€‚Check-inæ™‚é–“éœ€èˆ‡å±‹ä¸»ç¢ºèªã€‚'
            },
            {
                title: 'ğŸ¯ å²¡å±±åŸ & å²¡å±±å¾Œæ¨‚åœ’',
                category: 'æ™¯é»',
                mapLink: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6',
                icon: 'fas fa-chess-rook',
                description: 'å¾Œæ¨‚åœ’æ˜¯æ—¥æœ¬ä¸‰å¤§ååœ’ä¹‹ä¸€ï¼Œä»¥æ± æ³‰è¿´éŠå¼è¨­è¨ˆèåï¼Œä¸¦ä»¥å²¡å±±åŸç‚ºå€Ÿæ™¯ã€‚å²¡å±±åŸå› é»‘è‰²å¤–è§€ï¼Œåˆåã€ŒçƒåŸã€ã€‚å…©è€…åƒ…ä¸€æ©‹ä¹‹éš”ï¼Œæ˜¯å²¡å±±çš„ä»£è¡¨æ€§æ­·å²æ™¯é»ã€‚',
                tips: 'å»ºè­°ä¸‹åˆåƒè§€å¾Œæ¨‚åœ’ï¼Œæ¥è‘—åœ¨å‚æ™šæ™‚åˆ†è§€è³å²¡å±±åŸé»ç‡ˆå¾Œçš„å¤œæ™¯ã€‚'
            },
            {
                title: 'ğŸ›ï¸ æ°¸æ—ºå¤¢æ¨‚åŸï¼ˆAEON Mallï¼‰',
                category: 'è³¼ç‰©',
                mapLink: 'https://maps.app.goo.gl/qL3Z7R3G6WzH5Yw59',
                icon: 'fas fa-shopping-bag',
                description: 'ä½æ–¼å²¡å±±è»Šç«™å‰çš„å¤§å‹ç¶œåˆè³¼ç‰©ä¸­å¿ƒï¼Œé›†çµäº†æ™‚å°šã€ç¾é£Ÿã€å½±åŸç­‰å¤šåŠŸèƒ½è¨­æ–½ã€‚æ˜¯è³¼è²·ä¼´æ‰‹ç¦®å’Œç”¨é¤çš„å¥½å»è™•ã€‚',
                tips: 'åœ°ä¸‹æ¨“å±¤æœ‰è¶…å¸‚ï¼Œæ–¹ä¾¿è³¼è²·å®µå¤œå’Œç•¶åœ°ç‰¹è‰²é£Ÿå“ã€‚'
            },
            {
                title: 'ğŸ›¶ å€‰æ•·ç¾è§€åœ°å€',
                category: 'æ™¯é»',
                mapLink: 'https://maps.app.goo.gl/bM7R3tYQ1M9k4K2u5',
                icon: 'fas fa-water',
                description: 'ä¿ç•™æ±Ÿæˆ¶æ™‚ä»£é¢¨è²Œçš„ç™½å£å®…é‚¸è¡—é“ï¼ŒæŸ³æ¨¹æ²¿æ²³å·å‚è”­ï¼Œå……æ»¿è©©æ„ã€‚å¯ä»¥é«”é©—æ­ä¹˜å°èˆ¹æˆ–åƒè§€å¤§åŸç¾è¡“é¤¨ã€‚',
                tips: 'å¿…åƒã€Œæœ‰é„°åºµã€çš„å¹¸ç¦å¸ƒä¸ã€ã€Œå€‰æ•·æ¡ƒå­ã€çš„å­£ç¯€ç”œé»ã€‚å€‰æ•·ä¹Ÿæ˜¯æ—¥æœ¬ç‰›ä»”è¤²çš„ç™¼æºåœ°ã€‚'
            },
            {
                title: 'â›©ï¸ å‰å‚™æ´¥ç¥ç¤¾',
                category: 'æ™¯é»',
                mapLink: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6',
                icon: 'fas fa-torii-gate',
                description: 'å‚³èªªæ˜¯æ¡ƒå¤ªéƒå‚³èªªçš„ç™¼æºåœ°ã€‚ä»¥ç¨ç‰¹çš„ã€Œå‰å‚™æ´¥é€ ã€å»ºç¯‰é¢¨æ ¼æœ¬æ®¿å’Œé•·é” 400 å…¬å°ºçš„è¿´å»Šèåã€‚',
                tips: 'åƒæ‹œå®Œä¸»æ®¿å¾Œï¼Œä¸€å®šè¦æ²¿è‘—å£¯è§€çš„é•·å»Šèµ°ä¸€åœˆï¼Œæ„Ÿå—æ­·å²çš„æ²‰éœã€‚'
            },
            {
                title: 'ğŸ´ Gaho é›…èŠ³ï¼ˆãŒã»ã†ï¼‰å£½å–œç‡’',
                category: 'ç¾é£Ÿ',
                mapLink: 'https://maps.app.goo.gl/Qc2R8T3Y1V6G8JpQ6',
                icon: 'fas fa-utensils',
                description: 'å²¡å±±å¸‚å€å…§å—æ­¡è¿çš„å£½å–œç‡’æˆ–æ¶®æ¶®é‹å°ˆé–€åº—ï¼Œæä¾›é«˜å“è³ªçš„è‚‰å“å’Œå„ªé›…çš„ç”¨é¤ç’°å¢ƒã€‚',
                tips: 'å»ºè­°æå‰é€é Tabelog æˆ–å…¶ä»–æ–¹å¼è¨‚ä½ï¼Œç‰¹åˆ¥æ˜¯æ™šé¤æ™‚æ®µã€‚é¤å»³æä¾›ä¸­æ–‡èœå–®æœå‹™ã€‚'
            },
            {
                title: 'ğŸ¥¯ STAND1-1 è²æœ',
                category: 'ç¾é£Ÿ',
                mapLink: 'https://maps.app.goo.gl/u5K8y9e5Zq4hM1t2A',
                icon: 'fas fa-coffee',
                description: 'ä¸€å®¶é¢¨æ ¼ç¨ç‰¹çš„è²æœåº—ï¼Œæä¾›å¤šç¨®å£å‘³çš„è²æœå’Œå’–å•¡ï¼Œé©åˆç•¶ä½œæ—…é€”é–‹å§‹å‰çš„æ´»åŠ›æ—©é¤ã€‚',
                tips: 'é è¿‘è·¯é¢é›»è»Šç«™ï¼Œå¯ä»¥å¤–å¸¶ç•¶ä½œå‰å¾€ä¸‹ä¸€å€‹æ™¯é»çš„è·¯ä¸Šé¤é»ã€‚'
            },
            {
                title: 'ğŸš— Budget Car Rental å²¡å±±é§…å‰è¥¿å£åº—',
                category: 'äº¤é€š',
                mapLink: 'https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA',
                icon: 'fas fa-car',
                description: 'ä½æ–¼å²¡å±±è»Šç«™è¥¿å£ï¼Œæ–¹ä¾¿æ—…å®¢ç§Ÿè»Šå‰å¾€å››åœ‹é¦™å·æˆ–ç€¨æˆ¶å…§æµ·åœ°å€ã€‚',
                tips: 'å–è»Šæ™‚è«‹å‹™å¿…æª¢æŸ¥è»Šè¼›ç‹€æ³ï¼Œä¸¦ç¢ºèªå°èˆªç³»çµ±æ“ä½œæ–¹å¼ã€‚æ­¸é‚„æ™‚é–“éœ€åš´æ ¼éµå®ˆã€‚'
            },
            {
                title: 'ğŸŒ… é·²ç¾½å±±å±•æœ›å°',
                category: 'æ™¯é»',
                mapLink: 'https://maps.app.goo.gl/yJ6M3P5h4L8k9T1u8',
                icon: 'fas fa-mountain',
                description: 'æœ€ä½³è§€è³ç€¨æˆ¶å¤§æ©‹çš„åˆ¶é«˜é»ã€‚å¤©æ°£æ™´æœ—æ™‚ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°ç€¨æˆ¶å…§æµ·çš„å³¶å¶¼å’Œè·¨æµ·å¤§æ©‹çš„å®å‰ã€‚',
                tips: 'æ˜¯è§€è³æ—¥å‡ºå’Œæ—¥è½çš„ç†±é–€åœ°é»ï¼Œä¹Ÿæ˜¯é‡è¦çš„è‡ªç„¶å…¬åœ’ã€‚'
            },
            {
                title: 'ğŸ§— é‡‘åˆ€æ¯”ç¾…å®®',
                category: 'æ™¯é»',
                mapLink: 'https://maps.app.goo.gl/9Qd4w3j7mB4k2Z1j9',
                icon: 'fas fa-hiking',
                description: 'ä½æ–¼å››åœ‹é¦™å·ç¸£çš„çŸ¥åç¥ç¤¾ï¼Œä»¥ã€Œä¸€ç”Ÿä¸€å®šè¦å»ä¸€æ¬¡ã€èåã€‚åƒæ‹œè·¯å¾‘æ¥µé•·ï¼Œæœ¬å®®éœ€çˆ¬ 785 ç´šçŸ³éšã€‚',
                tips: 'åƒæ‹œå‰è«‹ç©¿è‘—èˆ’é©çš„é‹å­ï¼Œé«”åŠ›ä¸ä½³è€…å¯åˆ©ç”¨è¡¨åƒé“ä¸Šçš„è½å­æœå‹™ã€‚è¡¨åƒé“ä¸Šçš„çƒé¾éºµä¹Ÿæ˜¯å¿…åšç¾é£Ÿã€‚'
            },
            {
                title: 'ğŸ  å››åœ‹æ°´æ—é¤¨',
                category: 'æ™¯é»',
                mapLink: 'https://maps.app.goo.gl/Rk4W7Q2m8L5h3X1e9',
                icon: 'fas fa-fish',
                description: 'é¦™å·ç¸£æœ€æ–°çš„å¤§å‹æ°´æ—é¤¨ï¼Œä»¥ã€Œå››åœ‹æ°´æ™¯ã€ç‚ºä¸»é¡Œï¼Œå±•ç¤ºç€¨æˆ¶å…§æµ·åŠå¤ªå¹³æ´‹çš„è±å¯Œæµ·æ´‹ç”Ÿç‰©ã€‚',
                tips: 'é¤¨å…§è¨­è¨ˆç¾ä»£åŒ–ï¼Œä¸”é¢å‘ç€¨æˆ¶å…§æµ·ï¼Œæ™¯è§€æ¥µä½³ï¼Œæ˜¯è¦ªæ°´çš„å¥½åœ°æ–¹ã€‚'
            }
        ];

        // æ—…éŠè¡Œç¨‹è³‡æ–™ (ä¿æŒä¸è®Š)
        const ITINERARY = {
            1: {
                date: '01/16ï¼ˆå››ï¼‰',
                title: 'æŠµé”å²¡å±±èˆ‡å¸‚å€æ¼«æ­¥',
                events: [
                    { time: '14:35', desc: 'æŠµé”å²¡å±±æ©Ÿå ´', highlight: true, detail: 'IT214 èˆªç­ã€‚', map: 'https://maps.app.goo.gl/YfL4E5bQ9d2L6JqG9' },
                    { time: '14:45', desc: 'æ¥é§å·´å£«åˆ°ä½å®¿é£¯åº—', detail: 'å¾æ©Ÿå ´æ­ä¹˜å·´å£«å‰å¾€å²¡å±±é§…ã€‚', map: null },
                    { time: '15:30', desc: 'æŠµé”é£¯åº—', detail: 'ã›ã‹ã‚“ã©ã‚†ãƒ¼ã™è¥¿å£ 505è™Ÿå®¤ï¼Œæ”¾è¡Œæä¸¦Check-inã€‚', map: 'https://maps.app.goo.gl/3QW7v5c3X2yFwA648' },
                    { time: '16:00', desc: 'å²¡å±±å¾Œæ¨‚åœ’', detail: 'å¿«é€Ÿé€›ä¸»è¦æ™¯é»ã€‚', map: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6' },
                    { time: '17:30', desc: 'å²¡å±±åŸ å¤–åœæ‹ç…§', detail: 'çƒåŸé»‘è‰²å¤–è§€ã€‚', map: 'https://maps.app.goo.gl/JqFf7R6u9uXk9M2u8' },
                    { time: '18:30', desc: 'æ™šé¤ï¼šGaho é›…èŠ³ï¼ˆãŒã»ã†ï¼‰å£½å–œç‡’', detail: 'æå‰è¨‚ä½ã€‚', map: 'https://maps.app.goo.gl/Qc2R8T3Y1V6G8JpQ6', link: 'https://tabelog.com/okayama/A3301/A330101/33015482/' },
                    { time: '19:30', desc: 'æ°¸æ—ºå¤¢æ¨‚åŸï¼ˆAEON Mallï¼‰é€›è¡—', detail: 'å²¡å±±é§…å‰çš„å¤§å‹è³¼ç‰©ä¸­å¿ƒã€‚', map: 'https://maps.app.goo.gl/qL3Z7R3G6WzH5Yw59' },
                    { time: '21:00', desc: 'è¿”å›ä½å®¿', highlight: false, detail: 'æ­¥è¡Œæˆ–æ­ä¹˜è·¯é¢é›»è»Šã€‚', map: 'https://maps.app.goo.gl/3QW7v5c3X2yFwA648' },
                ]
            },
            2: {
                date: '01/17ï¼ˆäº”ï¼‰',
                title: 'å€‰æ•· + å‰å‚™æ´¥ç¥ç¤¾',
                events: [
                    { time: '08:00', desc: 'èµ·åºŠ â†’ æ—©é¤', highlight: true, detail: 'é£¯åº—å‘¨é‚Šæˆ–ä¾¿åˆ©å•†åº—ã€‚' },
                    { time: '08:20', desc: 'å‡ºé–€', detail: 'å‰å¾€å€‰æ•·ã€‚', map: null },
                    { time: '09:30', desc: 'å€‰æ•·æ•£ç­–', detail: 'å°èˆ¹ï¼æ²³é“æ‹ç…§ã€é˜¿æ™ºç¥ç¤¾çˆ¬å±±ã€Cafe Miyake / å€‰æ•·æ¡ƒå­ç”œé»ã€Denim Street / æœ‰é„°åºµã€‚', map: 'https://maps.app.goo.gl/bM7R3tYQ1M9k4K2u5', link: 'https://tabelog.com/okayama/A3302/A330201/33000547/' },
                    { time: '13:00', desc: 'åˆé¤ï¼šKappa è±¬æ’ (æ™‚é–“å…è¨±)', detail: 'è‹¥æ™‚é–“å…è¨±ï¼Œåœ¨å€‰æ•·è§£æ±ºã€‚', map: 'https://maps.app.goo.gl/7g8K1R4B3uXk9M2u8', link: 'https://tabelog.com/okayama/A3302/A330201/33000547/' },
                    { time: '14:00', desc: 'å‰å‚™æ´¥ç¥ç¤¾', detail: 'å‰å¾€æ¡ƒå¤ªéƒå‚³èªªçš„ç™¼æºåœ°ï¼Œé•·å»Šå¾ˆå£¯è§€ã€‚', map: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6' },
                    { time: '17:00', desc: 'å²¡å±±å¸‚å€æ™šé¤', detail: 'è¿”å›å²¡å±±å¸‚å€è¦“é£Ÿã€‚', map: null },
                    { time: '19:00', desc: 'è¿”å›ä½å®¿', highlight: false, detail: 'å¥½å¥½ä¼‘æ¯ã€‚', map: 'https://maps.app.goo.gl/3QW7v5c3X2yFwA648' },
                ]
            },
            3: {
                date: '01/18ï¼ˆå…­ï¼‰',
                title: 'å››åœ‹è‡ªé§•ï¼šé‡‘åˆ€æ¯”ç¾…å®®ï¼‹æ°´æ—é¤¨',
                events: [
                    { time: '07:30', desc: 'èµ·åºŠ', highlight: false, detail: 'æº–å‚™å‡ºç™¼ã€‚' },
                    { time: '08:00', desc: 'æ—©é¤ï¼šSTAND1-1 è²æœ', detail: 'æ­ä¹˜è·¯é¢é›»è»Šå‰å¾€ã€‚', map: 'https://maps.app.goo.gl/u5K8y9e5Zq4hM1t2A', link: 'https://tabelog.com/okayama/A3301/A330101/33019056/' },
                    { time: '08:40', desc: 'èµ°è·¯å‰å¾€ Budget Car Rental å²¡å±±é§…å‰è¥¿å£åº—', detail: 'æº–å‚™å–è»Šã€‚', map: 'https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA' },
                    { time: '09:00', desc: 'ç§Ÿè»Šå‡ºç™¼', highlight: true, detail: 'æº–æ™‚å–è»Šï¼Œé–‹å§‹è‡ªé§•è¡Œç¨‹ï¼', map: 'https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA' },
                    { time: '09:40', desc: 'é·²ç¾½å±±å±•æœ›å°æ‹ç…§', detail: 'é çœºç€¨æˆ¶å¤§æ©‹ã€‚', map: 'https://maps.app.goo.gl/yJ6M3P5h4L8k9T1u8' },
                    { time: '10:40', desc: 'é‡‘åˆ€æ¯”ç¾…å®® + è¡¨åƒé“æ•£ç­–', detail: 'æŒ‘æˆ° 785 éšï¼', map: 'https://maps.app.goo.gl/9Qd4w3j7mB4k2Z1j9' },
                    { time: '14:40', desc: 'å‰å¾€å››åœ‹æ°´æ—é¤¨', detail: 'è»Šç¨‹ç´„ 30 åˆ†é˜ã€‚', map: 'https://maps.app.goo.gl/Rk4W7Q2m8L5h3X1e9' },
                    { time: '15:10', desc: 'å››åœ‹æ°´æ—é¤¨', detail: 'æ¬£è³ç€¨æˆ¶å…§æµ·æ™¯è§€èˆ‡æ°´ç”Ÿå‹•ç‰©ã€‚', map: 'https://maps.app.goo.gl/Rk4W7Q2m8L5h3X1e9' },
                    { time: '18:20', desc: 'å›å²¡å±± â†’ å²¡å±±å¸‚å€æ™šé¤', highlight: false, detail: 'å›ç¨‹è«‹æ³¨æ„è·¯æ³ã€‚', map: null },
                    { time: '20:00', desc: 'è¿”å›ä½å®¿', detail: 'å°‡è»Šåœå¦¥ã€‚', map: 'https://maps.app.goo.gl/3QW7v5c3X2yFwA648' },
                ]
            },
            4: {
                date: '01/19ï¼ˆæ—¥ï¼‰',
                title: 'å²¡å±±å¸‚å€è‡ªç”± + å›ç¨‹',
                events: [
                    { time: '07:30', desc: 'èµ·åºŠ', highlight: false, detail: 'æ•´ç†è¡Œæã€‚' },
                    { time: '08:30', desc: 'ç§Ÿè»Šé‚„è»Š', highlight: true, detail: 'Budget Car Rental å²¡å±±é§…å‰è¥¿å£åº—ï¼Œæº–æ™‚æ­¸é‚„ã€‚', map: 'https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA' },
                    { time: '09:00', desc: 'ä¸Šåˆè‡ªç”±æ´»å‹•', detail: 'æ—©é¤ â†’ æ•´ç†è¡Œæ â†’ ä½å®¿å‘¨é‚Šè‡ªç”±æ´»å‹•ï¼Œè³¼è²·ä¼´æ‰‹ç¦®ã€‚', map: null },
                    { time: '12:00', desc: 'æ­æ¥é§å·´å£«å‰å¾€å²¡å±±æ©Ÿå ´', highlight: true, detail: 'åœ¨å²¡å±±é§…æ­ä¹˜ã€‚', map: 'https://maps.app.goo.gl/YfL4E5bQ9d2L6JqG9' },
                    { time: '15:25', desc: 'å‡ºç™¼å›å°', highlight: true, detail: 'è™èˆª IT215 ç™»æ©Ÿæ™‚é–“ï¼Œ17:30 æŠµé”å°åŒ—ã€‚', map: 'https://maps.app.goo.gl/YfL4E5bQ9d2L6JqG9' },
                ]
            }
        };


        // ====================================================================
        // UTILITY FUNCTIONS
        // ====================================================================

        function saveToLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadFromLocalStorage(key, defaultValue) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : defaultValue;
        }

        // ====================================================================
        // NAVIGATION & TAB MANAGEMENT
        // ====================================================================

        function showTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('nav-active'));
            
            // Show the selected tab content
            const targetTab = document.getElementById(`tab-${tabId}`);
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            // Add active class to the selected nav button
            const targetNav = document.getElementById(`nav-${tabId}`);
            if (targetNav) {
                targetNav.classList.add('nav-active');
            }

            // Specific refresh actions
            if (tabId === 'plan') {
                renderItinerary(currentDay);
            } else if (tabId === 'guide') {
                renderGuideContent(); // å‘¼å«æ–°çš„å°è¦½æ¸²æŸ“å‡½æ•¸
            } else if (tabId === 'wallet') {
                renderExpenseList();
                document.getElementById('exchange-rate').value = exchangeRate.toFixed(3);
                // ç¢ºä¿è¨ˆç®—å™¨åœ¨åˆ‡æ›é é¢å¾Œä¿æŒä¸Šæ¬¡çš„é–‹åˆç‹€æ…‹
                const body = document.getElementById('calculator-body');
                const icon = document.getElementById('calculator-toggle-icon');
                if (isCalculatorOpen) {
                    body.style.display = 'block';
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    body.style.display = 'none';
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            } else if (tabId === 'lists') {
                renderChecklist();
                renderMemoOutput();
            }
        }

        // ====================================================================
        // 1. PLAN TAB LOGIC
        // ====================================================================

        function changeDay(day) {
            currentDay = day;
            renderItinerary(day);
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('bg-opacity-80');
                btn.classList.add('bg-opacity-50');
            });
            document.querySelector(`.day-btn:nth-child(${day})`).classList.add('bg-opacity-80');
            document.querySelector(`.day-btn:nth-child(${day})`).classList.remove('bg-opacity-50');
        }

        function renderItinerary(day) {
            const container = document.getElementById('plan-itinerary');
            const dayData = ITINERARY[day];
            
            if (!dayData) return;

            let html = `
                <div class="card p-4 mb-4 weather-banner">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold">${dayData.date} (${dayData.title})</p>
                            <h3 class="text-2xl font-bold">é è¨ˆå¤©æ°£</h3>
                            <p class="text-xs">æ™´æ™‚å¤šé›² | 12Â°C / 5Â°C (è«‹é»æ“Šé€£çµæŸ¥çœ‹å³æ™‚)</p>
                        </div>
                        <i class="fas fa-sun text-4xl opacity-70"></i>
                    </div>
                    <a href="https://www.jma.go.jp/jma/index.html" target="_blank" class="text-xs mt-2 block font-medium underline">æŸ¥çœ‹æ—¥æœ¬æ°£è±¡å»³å®˜æ–¹é å ±</a>
                </div>
                
                <div class="space-y-4">
            `;

            dayData.events.forEach(event => {
                const timeClass = event.highlight ? 'highlight-time' : 'text-gray-500';
                
                let linkHtml = '';
                if (event.map) {
                    linkHtml += `<a href="${event.map}" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 mr-3"><i class="fas fa-map-marker-alt"></i> Google Maps</a>`;
                }
                if (event.link) {
                    linkHtml += `<a href="${event.link}" target="_blank" class="text-xs text-green-600 hover:text-green-800"><i class="fas fa-utensils"></i> é£Ÿè¨˜/é€£çµ</a>`;
                }

                html += `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="card p-3">
                            <div class="flex justify-between items-start">
                                <span class="text-lg font-bold ${timeClass}">${event.time}</span>
                                <span class="text-sm text-gray-500 mt-0.5">${event.desc}</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">${event.detail}</p>
                            <div class="mt-2 text-right">
                                ${linkHtml}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }
        
        // ====================================================================
        // 2. GUIDE TAB LOGIC (æ·±åº¦å°è¦½æ¸²æŸ“é‚è¼¯)
        // ====================================================================
        
        function renderGuideContent() {
            const container = document.getElementById('guide-content');
            let html = '';
            
            COMPREHENSIVE_GUIDE.forEach(poi => {
                let categoryColor = 'text-gray-700';
                switch (poi.category) {
                    case 'æ™¯é»':
                        categoryColor = 'text-indigo-700';
                        break;
                    case 'ç¾é£Ÿ':
                        categoryColor = 'text-red-700';
                        break;
                    case 'äº¤é€š':
                        categoryColor = 'text-blue-700';
                        break;
                    case 'ä½å®¿':
                        categoryColor = 'text-green-700';
                        break;
                }

                html += `
                    <div class="card p-4">
                        <h3 class="text-xl font-bold mb-3 border-b pb-2 ${categoryColor}">
                            <i class="${poi.icon} mr-2"></i> ${poi.title}
                        </h3>
                        <p class="text-xs font-medium text-gray-500 mb-2">ã€${poi.category}ã€‘</p>
                        <p class="text-sm leading-relaxed mb-3">${poi.description}</p>
                        <div class="bg-yellow-50 p-2 rounded-lg mb-3">
                            <p class="text-xs font-medium text-yellow-800"><i class="fas fa-lightbulb mr-1"></i> æ—…è¡Œå°è²¼å£«</p>
                            <p class="text-xs text-yellow-700 mt-1">${poi.tips}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-route map-icon text-lg"></i>
                            <a href="${poi.mapLink}" target="_blank" class="text-sm underline text-blue-500 hover:text-blue-700">Google åœ°åœ–å°èˆª</a>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ====================================================================
        // 3. WALLET TAB LOGIC (è¨˜å¸³èˆ‡åŒ¯ç‡)
        // ====================================================================

        function saveExpenses() {
            saveToLocalStorage(STORAGE_KEY_EXPENSES, expenses);
        }

        function saveExchangeRate() {
            localStorage.setItem(STORAGE_KEY_RATE, exchangeRate.toFixed(3));
        }

        // --- Calculator Toggle Logic ---
        function toggleCalculator() {
            const body = document.getElementById('calculator-body');
            const icon = document.getElementById('calculator-toggle-icon');
            
            isCalculatorOpen = !isCalculatorOpen;

            if (isCalculatorOpen) {
                body.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                body.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        // --- Calculator Core Logic ---
        let currentExpression = '';

        function appendToExpression(value) {
            if (value === 'C') {
                clearCalculator();
                return;
            }
            if (!isCalculatorOpen) toggleCalculator(); // Auto-open when typing
            currentExpression += value;
            document.getElementById('calculator-display').textContent = currentExpression;
            // Clear TWD result when expression changes
            document.getElementById('calculator-twd-result').textContent = 'ç´„ NT$ 0.00';
        }

        function clearCalculator() {
            currentExpression = '';
            document.getElementById('calculator-display').textContent = '0';
            document.getElementById('calculator-twd-result').textContent = 'ç´„ NT$ 0.00';
        }

        function calculateResult() {
            if (currentExpression === '') return;

            let result;
            try {
                // Safely evaluate the expression.
                const safeExpression = currentExpression.replace(/[^0-9+\-*/().]/g, '');
                result = eval(safeExpression);
                
                if (isNaN(result) || !isFinite(result)) {
                    throw new Error('Invalid calculation');
                }

                // Update display and store result for next operation start
                currentExpression = result.toString();
                document.getElementById('calculator-display').textContent = result.toFixed(0);

                // Convert to TWD
                const twdResult = result * exchangeRate;
                document.getElementById('calculator-twd-result').textContent = `ç´„ NT$ ${twdResult.toFixed(2)}`;

            } catch (e) {
                document.getElementById('calculator-display').textContent = 'éŒ¯èª¤';
                currentExpression = '';
            }
        }

        document.getElementById('exchange-rate').addEventListener('input', (e) => {
            exchangeRate = parseFloat(e.target.value);
            if (isNaN(exchangeRate)) exchangeRate = 0.22;
            saveExchangeRate();
            renderExpenseList(); // Refresh list with new rate
        });

        // --- Expense Form & Image Handling ---

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('item-name').value;
            const jpy = parseFloat(document.getElementById('item-jpy').value);
            const type = document.querySelector('input[name="payment-type"]:checked').value;
            const base64Photo = document.getElementById('photo-base64').value;
            
            if (isNaN(jpy) || jpy <= 0) {
                console.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ—¥å¹£é‡‘é¡');
                return;
            }

            const newExpense = {
                id: Date.now(),
                name,
                jpy,
                twd: (jpy * exchangeRate).toFixed(2),
                type,
                date: new Date().toLocaleDateString('zh-TW'),
                photo: base64Photo || null // Compressed Base64 string
            };

            expenses.unshift(newExpense);
            saveExpenses();
            renderExpenseList();

            // Reset form
            e.target.reset();
            document.getElementById('photo-base64').value = '';
        });

        // Photo Upload Handler (Canvas Compression)
        document.getElementById('item-photo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 150; // Thumbnail size
                    
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize to fit max size
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);

                    // Get compressed Base64 data URL (JPEG, quality 0.7)
                    const base64String = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('photo-base64').value = base64String;

                    // Optional: Show preview or confirmation
                    console.log('Image compressed and stored in hidden field.');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function deleteExpense(id) {
            expenses = expenses.filter(exp => exp.id !== id);
            saveExpenses();
            renderExpenseList();
        }

        function renderExpenseList() {
            const container = document.getElementById('expense-list');
            if (expenses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">ç›®å‰æ²’æœ‰ä»»ä½•è¨˜å¸³ç´€éŒ„ã€‚</p>';
                return;
            }

            let totalJPY = 0;
            let totalTWD = 0;

            const listHtml = expenses.map(exp => {
                totalJPY += exp.jpy;
                totalTWD += parseFloat(exp.jpy * exchangeRate); // Re-calculate based on current rate

                const photoHtml = exp.photo ? 
                    `<img src="${exp.photo}" alt="æ”¶æ“šç¸®åœ–" class="w-12 h-12 object-cover rounded-md mr-3 border border-gray-200">` : 
                    `<div class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-md mr-3"><i class="fas fa-image text-gray-400"></i></div>`;
                
                const typeIcon = exp.type === 'Cash' ? '<i class="fas fa-money-bill-wave text-green-500"></i>' : '<i class="fas fa-credit-card text-red-500"></i>';

                return `
                    <div class="card p-3 flex justify-between items-center">
                        <div class="flex items-start">
                            ${photoHtml}
                            <div>
                                <p class="font-medium text-base">${exp.name}</p>
                                <p class="text-xs text-gray-500">${exp.date} | ${typeIcon} ${exp.type}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-var(--color-accent)">Â¥ ${exp.jpy.toLocaleString()}</p>
                            <p class="text-sm text-gray-600">NT$ ${(exp.jpy * exchangeRate).toFixed(2)}</p>
                            <button onclick="deleteExpense(${exp.id})" class="text-xs text-red-400 hover:text-red-600 mt-1"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add total summary at the top
            const summaryHtml = `
                <div class="card p-4 bg-var(--color-primary) text-white mb-4">
                    <p class="text-sm font-light">ç¸½èŠ±è²» (ç•¶å‰åŒ¯ç‡ ${exchangeRate.toFixed(3)})</p>
                    <div class="flex justify-between items-end">
                        <span class="text-2xl font-bold">NT$ ${totalTWD.toFixed(2)}</span>
                        <span class="text-base">ç´„ Â¥ ${totalJPY.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = summaryHtml + listHtml;
        }

        // ====================================================================
        // 4. LISTS TAB LOGIC (æ¸…å–®èˆ‡å‚™å¿˜) - å·²æ›´æ–°
        // ====================================================================

        function saveChecklist() {
            saveToLocalStorage(STORAGE_KEY_CHECKLIST, checklistItems);
        }

        // é»æ“Šé …ç›®åˆ‡æ›ç‹€æ…‹
        function toggleChecklistItem(id) {
            const item = checklistItems.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                saveChecklist();
                renderChecklist();
            }
        }
        
        // æ–°å¢è‡ªè¨‚æ¸…å–®é …ç›®
        function addChecklistItem() {
            const input = document.getElementById('new-checklist-item');
            const text = input.value.trim();
            if (text) {
                const newItem = {
                    id: Date.now(), // ä½¿ç”¨æ™‚é–“æˆ³ä½œç‚ºå”¯ä¸€ ID
                    text: text,
                    checked: false,
                    removable: true // æ¨™è¨˜ç‚ºå¯ç§»é™¤
                };
                checklistItems.push(newItem);
                saveChecklist();
                renderChecklist();
                input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¬„
            }
        }
        
        // ç§»é™¤è‡ªè¨‚æ¸…å–®é …ç›®
        function removeChecklistItem(id) {
            checklistItems = checklistItems.filter(i => i.id !== id);
            saveChecklist();
            renderChecklist();
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-items');
            
            const html = checklistItems.map(item => {
                const textClass = item.checked ? 'line-through text-gray-400' : 'text-gray-700';
                
                // åªæœ‰å¯ç§»é™¤çš„é …ç›® (removable: true) æ‰æœƒé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
                const removeButton = item.removable ? 
                    `<button onclick="removeChecklistItem(${item.id})" class="text-red-400 hover:text-red-600 ml-auto p-1"><i class="fas fa-trash-alt"></i></button>` : 
                    '<div class="w-8"></div>'; // é ç•™ç©ºé–“ç”¨æ–¼å°é½Š

                return `
                    <div class="flex items-center p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <!-- é»æ“Šæ­¤å€åŸŸåˆ‡æ›ç‹€æ…‹ -->
                        <div class="flex items-center flex-grow" onclick="toggleChecklistItem(${item.id})">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} class="h-5 w-5 text-var(--color-primary) rounded border-gray-300 focus:ring-var(--color-primary) pointer-events-none">
                            <span class="ml-3 font-medium ${textClass}">${item.text}</span>
                        </div>
                        ${removeButton}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // --- Memo Logic ---
        document.getElementById('memo-text').addEventListener('input', (e) => {
            const text = e.target.value;
            localStorage.setItem(STORAGE_KEY_MEMO, text);
            renderMemoOutput(text);
        });

        function renderMemoOutput(text) {
            const container = document.getElementById('memo-links');
            const memoText = text === undefined ? localStorage.getItem(STORAGE_KEY_MEMO) || '' : text;
            
            document.getElementById('memo-text').value = memoText; // Ensure textarea is updated

            // Regex to find URLs (http/https only)
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = memoText.match(urlRegex) || [];
            
            if (urls.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400">æœªåµæ¸¬åˆ°ä»»ä½•ç¶²å€ã€‚</p>';
                return;
            }

            const linkHtml = urls.map((url, index) => {
                // Determine display text (remove http/https for cleaner look)
                const displayText = url.replace(/^(https?:\/\/)/, '').replace(/\/$/, '');

                return `
                    <a href="${url}" target="_blank" class="btn-primary flex items-center justify-center text-sm p-2 bg-indigo-500 hover:bg-indigo-600">
                        <i class="fas fa-link mr-2"></i> ${displayText}
                    </a>
                `;
            }).join('');

            container.innerHTML = linkHtml;
        }

        // ====================================================================
        // PWA & APP CONTROL LOGIC (æ–°å¢)
        // ====================================================================

        function isStandalone() {
            // åµæ¸¬æ˜¯å¦åœ¨ç¨ç«‹æ¨¡å¼ï¼ˆPWAï¼‰ä¸‹é‹è¡Œ
            return (window.matchMedia('(display-mode: standalone)').matches || document.referrer.includes('android-app://') || navigator.standalone);
        }

        function setupPWA() {
            // 1. å‹•æ…‹ç”Ÿæˆ Manifest æª”
            const manifest = {
                name: "å²¡å±±è¼•æ—… PWA",
                short_name: "å²¡å±±è¼•æ—…",
                description: "ä½ çš„å²¡å±±å››æ—¥è¼•æ—…è¡Œå°å¹«æ‰‹ï¼ŒåŒ…å«è¡Œç¨‹ã€å°è¦½ã€è¨˜å¸³èˆ‡æ¸…å–®ã€‚",
                start_url: "./index.html",
                display: "standalone",
                theme_color: "#5A7F7A",
                background_color: "#F0EDE5",
                icons: [
                    {
                        src: "https://placehold.co/192x192/5A7F7A/FFFFFF?text=JP",
                        sizes: "192x192",
                        type: "image/png"
                    },
                    {
                        src: "https://placehold.co/512x512/5A7F7A/FFFFFF?text=JP",
                        sizes: "512x512",
                        type: "image/png"
                    }
                ]
            };

            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-link').setAttribute('href', manifestUrl);

            // 2. éš±è— Splash Screen (æ¨¡æ“¬ App å•Ÿå‹•)
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.classList.add('hidden-splash');
                    // ç¢ºä¿å‹•ç•«çµæŸå¾Œç§»é™¤ DOMï¼Œé¿å…é»æ“Šå½±éŸ¿
                    setTimeout(() => {
                        splash.remove();
                    }, 600); 
                }
            }, 1500); // æ¨¡æ“¬ App å•Ÿå‹•æ™‚é–“ 1.5 ç§’

            // 3. åµæ¸¬ä¸¦é¡¯ç¤ºåŠ å…¥ä¸»ç•«é¢æç¤º (å¦‚æœä¸æ˜¯ç¨ç«‹ App æ¨¡å¼)
            const prompt = document.getElementById('a2hs-prompt');
            if (prompt) {
                if (!isStandalone()) {
                    prompt.style.display = 'flex';
                } else {
                    prompt.style.display = 'none';
                }
            }
        }


        // ====================================================================
        // INITIAL SETUP (DOM READY)
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // PWA Setup (å¿…é ˆåœ¨ DOM è¼‰å…¥å¾ŒåŸ·è¡Œ)
            setupPWA(); 
            
            // Load all data
            expenses = loadFromLocalStorage(STORAGE_KEY_EXPENSES, []);
            checklistItems = loadFromLocalStorage(STORAGE_KEY_CHECKLIST, null);
            exchangeRate = parseFloat(localStorage.getItem(STORAGE_KEY_RATE)) || 0.22;

            // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ï¼Œå¦‚æœæ¸…å–®ç‚ºç©ºï¼Œå‰‡åˆå§‹åŒ–å›ºå®šæ¸…å–®é …ç›®
            if (!checklistItems || checklistItems.length === 0) {
                 checklistItems = INITIAL_CHECKLIST_STRINGS.map((text, index) => ({
                    id: index + 1,
                    text: text,
                    checked: false,
                    removable: false // é è¨­é …ç›®ä¸å¯ç§»é™¤
                }));
                saveChecklist();
            }
            
            // Set initial state
            document.getElementById('exchange-rate').value = exchangeRate.toFixed(3);
            
            // Show default tab (PLAN)
            showTab('plan');
            changeDay(1);
        });

    </script>
</body>
</html>