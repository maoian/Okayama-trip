<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    
    <!-- ==========================================
         1. PWA & iOS å…¨è¢å¹•é—œéµè¨­å®š
    ========================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å²¡å±±è¼•æ—…">
    <meta name="theme-color" content="#5A7F7A">
    
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/5A7F7A/FFFFFF?text=JP">
    <link rel="manifest" id="manifest-link" href=""> 
    
    <title>å²¡å±±å››æ—¥è¼•æ—…</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #5A7F7A;
            --color-secondary: #F0EDE5;
            --color-accent: #E57373;
            --color-text: #2D3748;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-secondary);
            color: var(--color-text);
            padding-bottom: calc(72px + var(--safe-bottom)); 
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        header { padding-top: calc(1rem + var(--safe-top)) !important; }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--color-secondary);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }
        .splash-logo { font-size: 4rem; color: var(--color-primary); animation: float 2s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .loading-dots span {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--color-primary); margin: 0 4px; opacity: 0;
            animation: dot-fade 1.4s infinite both;
        }
        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dot-fade { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }

        .hidden-force { display: none !important; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .nav-active { color: var(--color-primary); font-weight: 500; }
        .tab-content { display: none; padding: 1rem; }
        .highlight-time { color: var(--color-accent); font-weight: 700; }
        .btn-primary { background-color: var(--color-primary); color: white; border-radius: 0.5rem; padding: 0.5rem 1rem; }
        .timeline-item { border-left: 2px solid var(--color-primary); padding-left: 1.5rem; margin-left: 0.5rem; position: relative; }
        .timeline-dot { position: absolute; left: -8px; top: 0.25rem; width: 14px; height: 14px; background-color: white; border: 2px solid var(--color-primary); border-radius: 9999px; }
        .weather-banner { background-image: linear-gradient(to right, #B2EBF2, #E0F7FA); color: #00838F; }
        
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .calculator-btn { background-color: #F8F8F8; border-radius: 0.5rem; padding: 0.75rem; font-size: 1.25rem; color: var(--color-text); }
        .calculator-btn:active { background-color: #E0E0E0; }
        .calculator-op { background-color: #E0F7FA; color: #00838F; }
        .calculator-eq { background-color: var(--color-primary); color: white; grid-column: span 2; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-logo mb-4"><i class="fas fa-torii-gate"></i></div>
        <h1 class="text-2xl font-bold text-gray-700 mb-2">å²¡å±±è¼•æ—…</h1>
        <p class="text-sm text-gray-500 mb-6">è¡Œç¨‹è¼‰å…¥ä¸­...</p>
        <div class="loading-dots"><span></span><span></span><span></span></div>
    </div>

    <!-- Header -->
    <header class="p-4 bg-white shadow-sm sticky top-0 z-10">
        <h1 class="text-xl font-bold text-center text-gray-800">å²¡å±±å››æ—¥è¼•æ—…è¡Œ</h1>
        <p class="text-sm text-center text-gray-500 mt-1">æ—¥ç³»æ—…éŠå°å¹«æ‰‹</p>
    </header>

    <!-- PWA Install Prompt -->
    <div id="pwa-install-prompt" class="hidden-force mx-4 mt-4 bg-yellow-50 border border-yellow-200 rounded-xl p-4 shadow-sm relative animate-bounce">
        <div class="flex items-start">
            <div class="text-yellow-500 text-xl mr-3"><i class="fas fa-mobile-alt"></i></div>
            <div>
                <h3 class="font-bold text-gray-800 text-sm mb-1">ç²å¾— App å…¨è¢å¹•é«”é©—</h3>
                <p class="text-xs text-gray-600 leading-relaxed">
                    é»æ“Šç€è¦½å™¨ä¸‹æ–¹ <i class="fas fa-share-square mx-1"></i> åˆ†äº«æŒ‰éˆ•<br>
                    é¸æ“‡ <span class="font-bold">ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</span> å³å¯å»é™¤ç¶²å€åˆ—
                </p>
            </div>
            <button onclick="document.getElementById('pwa-install-prompt').classList.add('hidden-force')" class="text-gray-400 ml-auto"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- Content -->
    <main id="app-content" class="pb-safe">

        <!-- PLAN -->
        <div id="tab-plan" class="tab-content block">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">âœˆï¸ è¡Œç¨‹ç¸½è¦½ (PLAN)</h2>
            <div class="flex justify-center mb-4 space-x-2">
                <button onclick="changeDay(1)" class="day-btn btn-primary bg-opacity-80">Day 1</button>
                <button onclick="changeDay(2)" class="day-btn btn-primary bg-opacity-50">Day 2</button>
                <button onclick="changeDay(3)" class="day-btn btn-primary bg-opacity-50">Day 3</button>
                <button onclick="changeDay(4)" class="day-btn btn-primary bg-opacity-50">Day 4</button>
            </div>
            <div id="plan-itinerary"></div>
        </div>

        <!-- GUIDE -->
        <div id="tab-guide" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">â›©ï¸ æ·±åº¦å°è¦½ (GUIDE)</h2>
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3">ğŸ“ æ—…ç¨‹åœ°åœ–æ¦‚è¦½</h3>
                <iframe id="guide-map" style="width:100%; height:300px; border-radius:1rem; border:0;"
                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d198884.2346740683!2d133.6841267425121!3d34.46824490704043!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x35511af41b802677%3A0x3500d4d7a72d326!2z5b6D5b6e5bmV55yM5b6D5b6e6aeF!5e0!3m2!1szh-TW!2stw!4v1701723652870!5m2!1szh-TW!2stw"
                    allowfullscreen="" loading="lazy"></iframe>
            </div>
            <div id="guide-content" class="space-y-4"></div>
        </div>

        <!-- WALLET -->
        <div id="tab-wallet" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ (WALLET)</h2>
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleCalculator()">
                    <h3 class="text-xl font-medium">åŒ¯ç‡æ›ç®—å™¨</h3>
                    <i id="calculator-toggle-icon" class="fas fa-chevron-up text-lg text-gray-500"></i>
                </div>
                <div id="calculator-body" class="mt-4">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-medium">åŒ¯ç‡ (JPY 1 = TWD)</label>
                        <input type="number" id="exchange-rate" value="0.22" step="0.001" class="w-24 p-2 border rounded-lg text-right">
                    </div>
                    <div class="bg-gray-100 p-3 rounded-xl mb-4">
                        <div id="calculator-display" class="text-right text-3xl font-bold mb-2 h-10 overflow-hidden">0</div>
                        <div id="calculator-twd-result" class="text-right text-base text-gray-600">ç´„ NT$ 0.00</div>
                    </div>
                    <div class="calculator-grid">
                        <button class="calculator-btn" onclick="appendToExpression('1')">1</button>
                        <button class="calculator-btn" onclick="appendToExpression('2')">2</button>
                        <button class="calculator-btn" onclick="appendToExpression('3')">3</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('+')"><i class="fas fa-plus"></i></button>
                        <button class="calculator-btn" onclick="appendToExpression('4')">4</button>
                        <button class="calculator-btn" onclick="appendToExpression('5')">5</button>
                        <button class="calculator-btn" onclick="appendToExpression('6')">6</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('-')"><i class="fas fa-minus"></i></button>
                        <button class="calculator-btn" onclick="appendToExpression('7')">7</button>
                        <button class="calculator-btn" onclick="appendToExpression('8')">8</button>
                        <button class="calculator-btn" onclick="appendToExpression('9')">9</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('*')"><i class="fas fa-times"></i></button>
                        <button class="calculator-btn" onclick="clearCalculator()">C</button>
                        <button class="calculator-btn" onclick="appendToExpression('0')">0</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('.')">.</button>
                        <button class="calculator-btn calculator-op" onclick="appendToExpression('/')"><i class="fas fa-divide"></i></button>
                        <button class="calculator-btn calculator-eq" onclick="calculateResult()">=</button>
                    </div>
                </div>
            </div>
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">æ–°å¢æ¶ˆè²»ç´€éŒ„</h3>
                <form id="expense-form" class="space-y-3">
                    <div><input type="text" id="item-name" placeholder="å“é …åç¨±" required class="w-full p-2 border rounded-lg"></div>
                    <div><input type="number" id="item-jpy" placeholder="æ—¥å¹£é‡‘é¡" required min="1" class="w-full p-2 border rounded-lg"></div>
                    <div>
                        <div class="flex space-x-4 mt-1">
                            <label><input type="radio" name="payment-type" value="Cash" checked> ç¾é‡‘</label>
                            <label><input type="radio" name="payment-type" value="Credit"> ä¿¡ç”¨å¡</label>
                        </div>
                    </div>
                    <div><input type="file" id="item-photo" accept="image/*" class="w-full text-sm text-gray-500"><input type="hidden" id="photo-base64"></div>
                    <button type="submit" class="btn-primary w-full mt-4"><i class="fas fa-plus mr-2"></i> æ–°å¢</button>
                </form>
            </div>
            <div id="expense-list" class="space-y-3"></div>
        </div>

        <!-- LISTS -->
        <div id="tab-lists" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">ğŸ“ æ¸…å–®èˆ‡å‚™å¿˜ (LISTS)</h2>
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2 text-green-700">è¡Œå‰æº–å‚™ Checklist</h3>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-checklist-item" placeholder="æ–°å¢é …ç›®..." class="flex-grow p-2 border rounded-lg">
                    <button onclick="addChecklistItem()" class="btn-primary flex-shrink-0"><i class="fas fa-plus"></i></button>
                </div>
                <div id="checklist-items" class="space-y-3"></div>
            </div>
            <div class="card p-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2 text-indigo-700">å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-text" rows="6" class="w-full p-3 border rounded-lg resize-none" placeholder="è¼¸å…¥å‚™å¿˜..."></textarea>
                <div id="memo-links" class="mt-4 space-y-2"></div>
            </div>
        </div>

        <!-- INFO -->
        <div id="tab-info" class="tab-content">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">â„¹ï¸ æ—…éŠè³‡è¨Š (INFO)</h2>
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">èˆªç­èˆ‡ä½å®¿</h3>
                <p class="text-sm mb-2"><i class="fas fa-plane text-blue-500"></i> å»ç¨‹: IT214 11:10-14:35</p>
                <p class="text-sm mb-4"><i class="fas fa-plane-arrival text-blue-500"></i> å›ç¨‹: IT215 15:25-17:30</p>
                <p class="text-sm font-medium">ğŸ  ä½å®¿</p>
                <p class="text-sm mb-2">ã›ã‹ã‚“ã©ã‚†ãƒ¼ã™è¥¿å£ 505å·å®¤</p>
                <a href="https://maps.app.goo.gl/3QW7v5c3X2yFwA648" target="_blank" class="text-xs text-blue-500 underline">é–‹å•Ÿåœ°åœ–</a>
            </div>
            <div class="card p-4 mb-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">ç§Ÿè»Šè³‡è¨Š</h3>
                <p class="text-sm mb-1"><i class="fas fa-car text-yellow-600"></i> Budget Car Rental å²¡å±±é§…å‰è¥¿å£åº—</p>
                <p class="text-sm">å–: 01/18 09:00 | é‚„: 01/19 08:30</p>
                <a href="https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA" target="_blank" class="text-xs text-blue-500 underline">åœ°åœ–å°èˆª</a>
            </div>
            <div class="card p-4">
                <h3 class="text-xl font-medium mb-3 border-b pb-2">ç·Šæ€¥é€£çµ¡</h3>
                <p class="text-sm">è­¦å¯Ÿ: 110 | æ•‘è­·è»Š: 119</p>
            </div>
        </div>
    </main>

    <!-- Nav Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-20 pb-[env(safe-area-inset-bottom)]">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <button id="nav-plan" class="nav-btn flex flex-col items-center p-2 nav-active" onclick="showTab('plan')"><i class="fas fa-calendar-alt text-lg"></i><span class="text-xs mt-1">è¡Œç¨‹</span></button>
            <button id="nav-guide" class="nav-btn flex flex-col items-center p-2" onclick="showTab('guide')"><i class="fas fa-compass text-lg"></i><span class="text-xs mt-1">å°è¦½</span></button>
            <button id="nav-wallet" class="nav-btn flex flex-col items-center p-2" onclick="showTab('wallet')"><i class="fas fa-wallet text-lg"></i><span class="text-xs mt-1">è¨˜å¸³</span></button>
            <button id="nav-lists" class="nav-btn flex flex-col items-center p-2" onclick="showTab('lists')"><i class="fas fa-list-ul text-lg"></i><span class="text-xs mt-1">æ¸…å–®</span></button>
            <button id="nav-info" class="nav-btn flex flex-col items-center p-2" onclick="showTab('info')"><i class="fas fa-info-circle text-lg"></i><span class="text-xs mt-1">è³‡è¨Š</span></button>
        </div>
    </nav>

    <script>
        // PWA Setup
        function initPWA() {
            const manifest = {
                name: "å²¡å±±è¼•æ—…", short_name: "å²¡å±±è¼•æ—…", start_url: ".", display: "standalone",
                background_color: "#F0EDE5", theme_color: "#5A7F7A",
                icons: [{ src: "https://placehold.co/192x192/5A7F7A/FFFFFF?text=JP", sizes: "192x192", type: "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.querySelector('#manifest-link').setAttribute('href', URL.createObjectURL(blob));

            if (!(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone)) {
                setTimeout(() => document.getElementById('pwa-install-prompt').classList.remove('hidden-force'), 2500);
            }
        }
        window.addEventListener('load', () => {
            initPWA();
            setTimeout(() => {
                const s = document.getElementById('splash-screen');
                s.style.opacity = '0';
                setTimeout(() => s.style.display = 'none', 600);
            }, 1500);
        });

        // App Data
        const ITINERARY = {
            1: {
                date: '01/16ï¼ˆå››ï¼‰', title: 'æŠµé”å²¡å±±',
                events: [
                    { time: '14:35', desc: 'æŠµé”å²¡å±±æ©Ÿå ´', highlight: true, detail: 'IT214 èˆªç­ã€‚', map: 'https://maps.app.goo.gl/YfL4E5bQ9d2L6JqG9' },
                    { time: '15:30', desc: 'æŠµé”é£¯åº—', detail: 'ã›ã‹ã‚“ã©ã‚†ãƒ¼ã™è¥¿å£ Check-in', map: 'https://maps.app.goo.gl/3QW7v5c3X2yFwA648' },
                    { time: '16:00', desc: 'å²¡å±±å¾Œæ¨‚åœ’', detail: 'å¿«é€Ÿé€›ä¸»è¦æ™¯é»', map: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6' },
                    { time: '17:30', desc: 'å²¡å±±åŸ', detail: 'å¤–åœæ‹ç…§', map: 'https://maps.app.goo.gl/JqFf7R6u9uXk9M2u8' },
                    { time: '18:30', desc: 'æ™šé¤ï¼šGaho é›…èŠ³', detail: 'å£½å–œç‡’ (éœ€è¨‚ä½)', map: 'https://maps.app.goo.gl/Qc2R8T3Y1V6G8JpQ6' },
                    { time: '19:30', desc: 'AEON Mall', detail: 'å²¡å±±é§…å‰é€›è¡—', map: 'https://maps.app.goo.gl/qL3Z7R3G6WzH5Yw59' },
                    { time: '21:00', desc: 'è¿”å›ä½å®¿', detail: 'ä¼‘æ¯' }
                ]
            },
            2: {
                date: '01/17ï¼ˆäº”ï¼‰', title: 'å€‰æ•· + å‰å‚™æ´¥',
                events: [
                    { time: '08:00', desc: 'æ—©é¤', highlight: true },
                    { time: '09:30', desc: 'å€‰æ•·æ•£ç­–', detail: 'å°èˆ¹ã€é˜¿æ™ºç¥ç¤¾ã€å€‰æ•·æ¡ƒå­ç”œé»', map: 'https://maps.app.goo.gl/bM7R3tYQ1M9k4K2u5' },
                    { time: '13:00', desc: 'åˆé¤', detail: 'Kappa è±¬æ’ (è‹¥æ™‚é–“å…è¨±)', map: 'https://maps.app.goo.gl/7g8K1R4B3uXk9M2u8' },
                    { time: '14:00', desc: 'å‰å‚™æ´¥ç¥ç¤¾', detail: 'æ¡ƒå¤ªéƒå‚³èªª', map: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6' },
                    { time: '17:00', desc: 'å²¡å±±å¸‚å€æ™šé¤', detail: 'å¸‚å€è¦“é£Ÿ' }
                ]
            },
            3: {
                date: '01/18ï¼ˆå…­ï¼‰', title: 'å››åœ‹è‡ªé§•',
                events: [
                    { time: '08:00', desc: 'æ—©é¤', detail: 'STAND1-1 è²æœ', map: 'https://maps.app.goo.gl/u5K8y9e5Zq4hM1t2A' },
                    { time: '09:00', desc: 'ç§Ÿè»Šå‡ºç™¼', highlight: true, detail: 'Budget ç§Ÿè»Šå–è»Š', map: 'https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA' },
                    { time: '09:40', desc: 'é·²ç¾½å±±å±•æœ›å°', detail: 'æ‹ç…§', map: 'https://maps.app.goo.gl/yJ6M3P5h4L8k9T1u8' },
                    { time: '10:40', desc: 'é‡‘åˆ€æ¯”ç¾…å®®', detail: '785éšæ¢¯æŒ‘æˆ°', map: 'https://maps.app.goo.gl/9Qd4w3j7mB4k2Z1j9' },
                    { time: '15:10', desc: 'å››åœ‹æ°´æ—é¤¨', detail: 'ç€¨æˆ¶å…§æµ·æ™¯è§€', map: 'https://maps.app.goo.gl/Rk4W7Q2m8L5h3X1e9' },
                    { time: '18:20', desc: 'å›å²¡å±±æ™šé¤', detail: 'å¸‚å€' }
                ]
            },
            4: {
                date: '01/19ï¼ˆæ—¥ï¼‰', title: 'å›ç¨‹',
                events: [
                    { time: '08:30', desc: 'ç§Ÿè»Šé‚„è»Š', highlight: true, map: 'https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA' },
                    { time: '09:00', desc: 'è‡ªç”±æ´»å‹•', detail: 'è³¼è²·ä¼´æ‰‹ç¦®' },
                    { time: '12:00', desc: 'å‰å¾€æ©Ÿå ´', highlight: true, detail: 'å²¡å±±é§…æ­å·´å£«' },
                    { time: '15:25', desc: 'å‡ºç™¼å›å°', highlight: true, detail: 'IT215 -> å°åŒ—' }
                ]
            }
        };

        const GUIDE_DATA = [
            { title: 'å²¡å±±å¾Œæ¨‚åœ’', icon: 'fas fa-tree', cat: 'æ™¯é»', desc: 'æ—¥æœ¬ä¸‰å¤§ååœ’ä¹‹ä¸€ï¼Œæ¡æ± æ³‰è¿´éŠå¼è¨­è¨ˆã€‚', map: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6' },
            { title: 'å²¡å±±åŸ (çƒåŸ)', icon: 'fas fa-chess-rook', cat: 'æ™¯é»', desc: 'é»‘è‰²å¤–è§€çš„å¤©å®ˆé–£ï¼Œèˆ‡å¾Œæ¨‚åœ’ç›¸æœ›ã€‚', map: 'https://maps.app.goo.gl/wJ137Wf7q5cE2JpQ6' },
            { title: 'å€‰æ•·ç¾è§€åœ°å€', icon: 'fas fa-water', cat: 'æ™¯é»', desc: 'ç™½å£å®…é‚¸ã€æŸ³æ¨¹æ²³å²¸ï¼Œæ±Ÿæˆ¶é¢¨æƒ…ã€‚', map: 'https://maps.app.goo.gl/bM7R3tYQ1M9k4K2u5' },
            { title: 'é‡‘åˆ€æ¯”ç¾…å®®', icon: 'fas fa-hiking', cat: 'æ™¯é»', desc: 'ä¾›å¥‰æµ·ä¸Šäº¤é€šä¹‹ç¥ï¼Œéœ€çˆ¬785éšã€‚', map: 'https://maps.app.goo.gl/9Qd4w3j7mB4k2Z1j9' },
            { title: 'å››åœ‹æ°´æ—é¤¨', icon: 'fas fa-fish', cat: 'æ™¯é»', desc: 'ä»¥å››åœ‹æ°´æ™¯ç‚ºä¸»é¡Œï¼Œé¢å‘ç€¨æˆ¶å…§æµ·ã€‚', map: 'https://maps.app.goo.gl/Rk4W7Q2m8L5h3X1e9' },
            { title: 'Budget ç§Ÿè»Š', icon: 'fas fa-car', cat: 'äº¤é€š', desc: 'å²¡å±±é§…å‰è¥¿å£åº—ã€‚', map: 'https://maps.app.goo.gl/m3P3Qz9E8WqA4K2eA' },
            { title: 'å²¡å±±æ©Ÿå ´', icon: 'fas fa-plane', cat: 'äº¤é€š', desc: 'å¾€è¿”å°åŒ—çš„é–€æˆ¶ã€‚', map: 'https://maps.app.goo.gl/YfL4E5bQ9d2L6JqG9' }
        ];

        // Storage & Render Logic
        let expenses = [], checklistItems = [], currentDay = 1, exchangeRate = 0.22, isCalculatorOpen = true;
        const KEY_EXP = 'okayamaTripExpenses', KEY_CHK = 'okayamaTripChecklist', KEY_MEMO = 'okayamaTripMemo', KEY_RATE = 'okayamaTripExchangeRate';

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('nav-active'));
            document.getElementById(`tab-${id}`).style.display = 'block';
            document.getElementById(`nav-${id}`).classList.add('nav-active');
            if(id==='plan') renderItinerary(currentDay);
            if(id==='guide') renderGuide();
            if(id==='wallet') renderExpense();
            if(id==='lists') renderChecklist();
        }

        function changeDay(d) { currentDay = d; renderItinerary(d); document.querySelectorAll('.day-btn').forEach((b,i)=>b.className = `day-btn btn-primary ${i+1===d?'bg-opacity-80':'bg-opacity-50'}`); }

        function renderItinerary(d) {
            const data = ITINERARY[d];
            const html = data.events.map(e => `
                <div class="timeline-item"><div class="timeline-dot"></div><div class="card p-3">
                <div class="flex justify-between"><span class="text-lg font-bold ${e.highlight?'highlight-time':'text-gray-500'}">${e.time}</span><span class="text-sm text-gray-500">${e.desc}</span></div>
                <p class="text-xs text-gray-600 mt-1">${e.detail||''}</p>
                ${e.map?`<div class="mt-2 text-right"><a href="${e.map}" target="_blank" class="text-xs text-blue-500"><i class="fas fa-map-marker-alt"></i> åœ°åœ–</a></div>`:''}
                </div></div>`).join('');
            document.getElementById('plan-itinerary').innerHTML = `<div class="card p-4 mb-4 weather-banner"><p class="font-bold">${data.date} ${data.title}</p><p class="text-xs">é å ±: æ™´æ™‚å¤šé›²</p></div><div class="space-y-4">${html}</div>`;
        }

        function renderGuide() {
            document.getElementById('guide-content').innerHTML = GUIDE_DATA.map(g => `
                <div class="card p-4"><h3 class="text-xl font-bold mb-2 ${g.cat==='æ™¯é»'?'text-indigo-700':g.cat==='ç¾é£Ÿ'?'text-red-700':'text-blue-700'}"><i class="${g.icon} mr-2"></i>${g.title}</h3>
                <p class="text-xs text-gray-500 mb-1">ã€${g.cat}ã€‘</p><p class="text-sm mb-2">${g.desc}</p>
                <a href="${g.map}" target="_blank" class="text-sm text-blue-500 underline">Google Map</a></div>`).join('');
        }

        // Wallet
        function toggleCalculator() { isCalculatorOpen=!isCalculatorOpen; document.getElementById('calculator-body').style.display=isCalculatorOpen?'block':'none'; document.getElementById('calculator-toggle-icon').className=isCalculatorOpen?'fas fa-chevron-up text-lg text-gray-500':'fas fa-chevron-down text-lg text-gray-500'; }
        let expr=''; function appendToExpression(v){expr+=v;updCalc();} function clearCalculator(){expr='';updCalc();} function calculateResult(){try{expr=eval(expr).toString();}catch{expr='Error';}updCalc();}
        function updCalc(){ document.getElementById('calculator-display').textContent=expr||'0'; const v=parseFloat(expr); if(!isNaN(v)) document.getElementById('calculator-twd-result').textContent=`ç´„ NT$ ${(v*exchangeRate).toFixed(2)}`; }
        
        document.getElementById('expense-form').addEventListener('submit',e=>{
            e.preventDefault(); const name=document.getElementById('item-name').value, jpy=parseFloat(document.getElementById('item-jpy').value), type=document.querySelector('input[name="payment-type"]:checked').value, photo=document.getElementById('photo-base64').value;
            expenses.unshift({id:Date.now(), name, jpy, type, photo}); localStorage.setItem(KEY_EXP, JSON.stringify(expenses)); renderExpense(); e.target.reset();
        });
        document.getElementById('item-photo').addEventListener('change',e=>{
            const f=e.target.files[0]; if(!f)return; const r=new FileReader();
            r.onload=ev=>{ const i=new Image(); i.onload=()=>{ const c=document.createElement('canvas'), ctx=c.getContext('2d'), max=150; let w=i.width, h=i.height; if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}} c.width=w;c.height=h; ctx.drawImage(i,0,0,w,h); document.getElementById('photo-base64').value=c.toDataURL('image/jpeg',0.7); }; i.src=ev.target.result; }; r.readAsDataURL(f);
        });
        function renderExpense(){
            let twd=0, jpy=0; const html=expenses.map(e=>{ jpy+=e.jpy; twd+=e.jpy*exchangeRate; return `<div class="card p-3 flex justify-between items-center"><div class="flex items-start">${e.photo?`<img src="${e.photo}" class="w-12 h-12 rounded mr-3 object-cover">`:''}<div><p class="font-medium">${e.name}</p><p class="text-xs text-gray-500">${e.type}</p></div></div><div class="text-right"><p class="font-bold text-lg text-red-500">Â¥${e.jpy}</p><p class="text-xs text-gray-500">NT$${(e.jpy*exchangeRate).toFixed(0)}</p><button onclick="delExp(${e.id})" class="text-red-400 text-xs"><i class="fas fa-trash"></i></button></div></div>`; }).join('');
            document.getElementById('expense-list').innerHTML = `<div class="card p-4 bg-var(--color-primary) text-white mb-4 flex justify-between"><span class="text-xl font-bold">NT$ ${twd.toFixed(0)}</span><span>Â¥ ${jpy}</span></div>`+html;
        }
        function delExp(id){ expenses=expenses.filter(e=>e.id!==id); localStorage.setItem(KEY_EXP,JSON.stringify(expenses)); renderExpense(); }

        // Checklist
        function addChecklistItem(){ const v=document.getElementById('new-checklist-item').value; if(v){checklistItems.push({id:Date.now(),text:v,checked:false,removable:true}); localStorage.setItem(KEY_CHK,JSON.stringify(checklistItems)); renderChecklist(); document.getElementById('new-checklist-item').value='';} }
        function toggleCheck(id){ const i=checklistItems.find(x=>x.id===id); if(i){i.checked=!i.checked; localStorage.setItem(KEY_CHK,JSON.stringify(checklistItems)); renderChecklist();} }
        function removeCheck(id){ checklistItems=checklistItems.filter(x=>x.id!==id); localStorage.setItem(KEY_CHK,JSON.stringify(checklistItems)); renderChecklist(); }
        function renderChecklist(){ document.getElementById('checklist-items').innerHTML=checklistItems.map(i=>`<div class="flex items-center p-3 bg-gray-50 rounded-lg"><div class="flex-grow flex items-center cursor-pointer" onclick="toggleCheck(${i.id})"><input type="checkbox" ${i.checked?'checked':''} class="mr-3 pointer-events-none text-teal-600"><span class="${i.checked?'line-through text-gray-400':''}">${i.text}</span></div>${i.removable?`<button onclick="removeCheck(${i.id})" class="text-red-400 ml-2"><i class="fas fa-trash"></i></button>`:''}</div>`).join(''); }

        document.getElementById('memo-text').addEventListener('input',e=>{ const v=e.target.value; localStorage.setItem(KEY_MEMO,v); const u=v.match(/(https?:\/\/[^\s]+)/g)||[]; document.getElementById('memo-links').innerHTML=u.map(l=>`<a href="${l}" target="_blank" class="btn-primary block text-center text-sm py-2 mt-2 truncate"><i class="fas fa-link"></i> ${l}</a>`).join(''); });

        // Init
        window.addEventListener('load', ()=>{
            // Load Data
            expenses = JSON.parse(localStorage.getItem(KEY_EXP)||'[]');
            checklistItems = JSON.parse(localStorage.getItem(KEY_CHK)||'[]');
            exchangeRate = parseFloat(localStorage.getItem(KEY_RATE))||0.22;
            if(checklistItems.length===0) ['è­·ç…§','ç¶²å¡','å……é›»ç·š','éŒ¢åŒ…'].forEach((t,i)=>checklistItems.push({id:i,text:t,checked:false,removable:false}));
            
            document.getElementById('exchange-rate').value = exchangeRate;
            document.getElementById('exchange-rate').addEventListener('input', e=>{ exchangeRate=parseFloat(e.target.value)||0.22; localStorage.setItem(KEY_RATE,exchangeRate); renderExpense(); });
            document.getElementById('memo-text').value = localStorage.getItem(KEY_MEMO)||'';
            document.getElementById('memo-text').dispatchEvent(new Event('input'));

            // Init UI
            showTab('plan'); changeDay(1);

            // Hide Splash
            setTimeout(()=>{
                const s = document.getElementById('splash-screen');
                s.style.opacity='0';
                setTimeout(()=>s.style.display='none',600);
            }, 1500);

            // PWA Manifest
            const m = { name:"å²¡å±±è¼•æ—…", short_name:"å²¡å±±è¼•æ—…", display:"standalone", start_url:".", background_color:"#F0EDE5", theme_color:"#5A7F7A", icons:[{src:"https://placehold.co/192x192/5A7F7A/FFFFFF?text=JP",sizes:"192x192",type:"image/png"}] };
            document.getElementById('manifest-link').href = URL.createObjectURL(new Blob([JSON.stringify(m)],{type:'application/json'}));

            // Detect Mode
            if(!(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone)) {
                setTimeout(()=>document.getElementById('pwa-install-prompt').classList.remove('hidden-force'),2500);
            }
        });
    </script>
</body>
</html>